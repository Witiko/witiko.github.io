---
layout: post
title: "Static analysis of expl3 programs (11): Inter-file dependencies, segments, and code coverage"
tags:
  - expl3
  - LaTeX
  - programming
  - devlog
date: 2025-09-30
last_modified_at: 2025-09-30
excerpt_separator: <!-- more -->
---

Today, I'm excited to release the next major [update][2] to [_expltools_][1], a bundle that includes the static analysis tool _explcheck_ for the expl3 programming language. This update improves upon the **semantic analysis** processing step introduced in the [previous post][3] and lays groundwork for the final processing step of **flow analysis**.

<!-- more -->

# Inter-file dependencies

The original [project proposal][4] assumed that files would be checked individually. In practice, this limited the **semantic analysis** of multi-file projects, where one file defines a symbol and another uses it. To address this, the new release introduces the concept of _file groups_: sets of files that are assumed to be used together.

For example, suppose we have a file `foo.tex`:

    \cs_new:Nn
      \__example_foo:n
      { foo }
    \cs_generate_variant:Nn
      \__example_foo:n
      { V }

and another file `bar.tex`:

    \__example_foo:V
      \l_tmpa_tl

Previously, running `explcheck foo.tex bar.tex` produced:

    Checking 2 files

    Checking foo.tex                                         1 warning

        foo.tex:4:1:              W402 unused private function variant

    Checking bar.tex                                           1 error

        bar.tex:1:1:                E408 calling an undefined function

    Total: 1 error, 1 warning in 2 files

With the new release, files from the same directory are automatically grouped, and the result changes to:

    Checking 2 files

    Checking foo.tex                                                OK
    Checking bar.tex                                                OK

    Total: 0 errors, 0 warnings in 2 files

This greatly reduces false positives.

You can control this behavior with the `--group-files` option or by using `+` and `,` between filenames to group or separate them.

In addition, _explcheck_ will report missing symbols from external packages. To suppress these, use the `imported_prefixes` option in your configuration.

# Segments

Earlier versions of _explcheck_ had special-case support for only one kind of nested code: function replacement texts. For instance, consider the example from a [previous post][5]:

    \cs_new:Nn
      \example_foo:n
      {
        \cs_new:Nn
          \example_bar:n
          {
            #1,~##1!
          }
      }
    \example_foo:n { Hello }
    \example_bar:n { world }

Here we have three top-level calls (`\cs_new:Nn`, `\example_foo:n`, `\example_bar:n`) and two replacement texts.

But expl3 contains many more forms of nested code: `T`- and `F`-branches of conditional functions, loop bodies (e.g., `\ior_map_inline:Nn`), keyâ€“value definitions, and more. Ad-hoc support for each would be brittle, and the upcoming **flow analysis** requires a uniform way to connect code across different nesting types and levels.

To address this, the new release introduces _segments_, a unified representation for both top-level and nested code. This simplifies implementation and makes future extensions easier.

{% include image.html url="er-diagram.svg" thumburl="er-diagram.png"
   description="Entity relationship diagram of the analysis data model, highlighting our representation of input files." %}

The first new segment type added is [support for `T`- and `F`-branches of conditional functions][6], and future updates will continue expanding segment coverage.

# Code coverage

To show how well _explcheck_ understands a piece of code, the `--verbose` output now reports **code coverage**: the ratio of _well-understood_ expl3 tokens to the total number of tokens. A token is well-understood if it is either simple text or part of a recognized statement in the most deeply nested segment containing it.

For example:

    \cs_new:Nn
      \example_baz:n
      { \unexpected }
    some~text

- The nine tokens in `some~text` are well-understood (simple text).
- The four tokens `\cs_new:Nn`, `\example_baz:n`, `{`, and `}` are well-understood (recognized statement).
- The token `\unexpected` is _not_ well-understood, because there are no recognized statements in the replacement text.

Thus, coverage = 13/14 tokens â‰ˆ 93%.

For context, _explcheck_ currently achieves ~8% code coverage across all expl3 code in TeX Live. Future releases aim to raise this figure by recognizing more statements, segment types, and plain TeX / LaTeX2e constructs.

# Working with the community

Since March, I've been reaching out to package maintainers with reports of issues found by _explcheck_. Of 11 reported issues, 8 have already been fixed:

1. [BITNP/BIThesis#604](https://github.com/BITNP/BIThesis/issues/604): fixed
2. [jspitz/jslectureplanner#7](https://github.com/jspitz/jslectureplanner/issues/7): fixed
3. [dbitouze/nwejm#5](https://github.com/dbitouze/nwejm/issues/5)
4. [dbitouze/gzt#56](https://github.com/dbitouze/gzt/issues/56)
5. [michal-h21/responsive-latex#1](https://github.com/michal-h21/responsive-latex/issues/1): fixed
6. [fpantigny/nicematrix#12](https://github.com/fpantigny/nicematrix/issues/12): fixed
7. [josephwright/siunitx#796](https://github.com/josephwright/siunitx/issues/796): wontfix
8. [BITNP/BIThesis#640](https://github.com/BITNP/BIThesis/issues/640): fixed
9. [se2p/se2thesis#23](https://github.com/se2p/se2thesis/issues/23): fixed
10. [John02139/asmeconf#11](https://github.com/John02139/asmeconf/issues/11): fixed
11. [dickimaw-books.com#303](https://dickimaw-books.com/bugtracker.php?key=303): fixed

Following todayâ€™s update, at least 15 new potential issues were detected in public TeX Live repositories. Reports have been submitted, including:

12. An email to Martin Hensel about [the issues detected in package mhchem][8]
13. An email to Herbert VoÃŸ about [the issues detected in package hvarabic][9]
14. An email to Andrew Parsloe about the issues detected in [their many packages][10]
15. [nwafu_nan/nwafuthesis-l3#ID0M68][12]
16. [nwafu_nan/chinesechess#ID0MAM][11]
17. [samcarter/beamertheme-tcolorbox#5][13]
18. [hust-latex/hustthesis#45][14]
19. [Zeta611/simplebnf#10][15]
20. [irenier/sysuthesis#1][16]
21. [slatex/sTeX#453][17]
22. [dcpurton/scripture#117][18]
23. [luatexja/luatexja#35][19]
24. [leo-colisson/robust-externalize#59][20]
25. [Vidabe/cooking-units#32][21]
26. [fpantigny/nicematrix#117][18]

Let's see how many more we can fix before the next update! ðŸ˜‰

# Get involved!

Your feedback is invaluable. Feel free to contribute or share your thoughts by visiting [the project repository][7]. More improvements are on the way as _explcheck_ continues to grow.

 [1]: https://ctan.org/pkg/expltools
 [2]: https://github.com/Witiko/expltools/releases/tag/2025-09-29
 [3]: /Expl3-Linter-10
 [4]: https://tug.org/tc/devfund/documents/2024-09-expltools.pdf
 [5]: /Expl3-Linter-8.5
 [6]: https://github.com/witiko/expltools/issues/92
 [7]: https://github.com/Witiko/expltools/
 [8]: https://koppor.github.io/explcheck-issues/texmf-dist/tex/latex/mhchem/mhchem.sty
 [9]: https://koppor.github.io/explcheck-issues/texmf-dist/tex/latex/hvarabic/hvarabic.sty
 [10]: https://ctan.org/author/parsloe
 [11]: https://gitee.com/nwafu_nan/chinesechess/issues/ID0MAM
 [12]: https://gitee.com/nwafu_nan/nwafuthesis-l3/issues/ID0M68
 [13]: https://github.com/samcarter/beamertheme-tcolorbox/issues/5
 [14]: https://github.com/hust-latex/hustthesis/issues/45
 [15]: https://github.com/Zeta611/simplebnf/issues/10
 [16]: https://github.com/irenier/sysuthesis/issues/1
 [17]: https://github.com/slatex/sTeX/issues/453
 [18]: https://github.com/dcpurton/scripture/issues/117
 [19]: https://github.com/luatexja/luatexja/issues/35
 [20]: https://github.com/leo-colisson/robust-externalize/issues/59
 [21]: https://github.com/Vidabe/cooking-units/issues/32
 [22]: https://github.com/fpantigny/nicematrix/issues/18
